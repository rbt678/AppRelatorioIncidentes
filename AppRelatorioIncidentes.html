<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Relatório de Incidentes de Teste</title>
    <!-- Adicionado link para o Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- A folha de estilo será adicionada no final do documento -->
</head>

<body>
    <header>
        <nav>
            <ul class="menu">
                <li><a href="#" data-screen="relatorios"><i
                            class="material-icons">description</i><span>Relatórios</span></a></li>
            </ul>
        </nav>
    </header>
    <main class="container" id="content">
        <!-- Conteúdo dinâmico aqui -->
    </main>
    <!-- Modal para novo relatório -->
    <div id="newReportModal" class="modal">
        <div class="modal-content">
            <span class="close-button"><i class="material-icons">close</i></span>
            <h2><i class="material-icons">add_circle_outline</i> Criar Novo Relatório</h2>
            <div class="modal-form-group">
                <label for="modalReportId" class="modal-label">ID do Relatório <span
                        class="required-field"></span></label>
                <input type="text" id="modalReportId" class="modal-input" placeholder="AW-RIT-X" required>
                <span id="modalReportIdError" class="error"></span>
            </div>
            <div class="modal-form-group">
                <label for="modalSummary" class="modal-label">Resumo do Relatório <span
                        class="required-field"></span></label>
                <textarea id="modalSummary" class="modal-textarea" placeholder="Digite o resumo aqui"
                    required></textarea>
                <span id="modalSummaryError" class="error"></span>
            </div>
            <button id="createReportButton" class="modal-button">Criar Relatório</button>
        </div>
    </div>
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button"><i class="material-icons">close</i></span>
            <h2><i class="material-icons">help_outline</i> Confirmação</h2>
            <p id="confirmationMessage"></p>
            <div class="modal-buttons">
                <button id="confirmYes" class="modal-button confirm-button">Sim</button>
                <button id="confirmNo" class="modal-button cancel-button">Não</button>
            </div>
        </div>
    </div>
    <div id="imageModal" class="modal">
        <div class="modal-image-content">
            <span class="close-image-modal-button">×</span>
            <img id="modalImage" src="" alt="Imagem Ampliada">
        </div>
    </div>
    <div id="notification" class="notification">
        <i class="material-icons notification-icon"></i>
        <span id="notificationMessage" class="notification-message"></span>
        <button id="closeNotification" class="notification-close"><i class="material-icons">close</i></button>
    </div>
    <div id="loadingIndicator" class="loading-indicator">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>
    <!-- Elemento para exibir mensagens de erro ou sucesso -->
    <div id="messageContainer" style="display:none;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.menu a');
            const contentDiv = document.getElementById('content');
            const newReportModal = document.getElementById('newReportModal');
            const closeModalButton = document.querySelector('.close-button');
            const createReportButton = document.getElementById('createReportButton');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmYesButton = document.getElementById('confirmYes');
            const confirmNoButton = document.getElementById('confirmNo');
            const notification = document.getElementById('notification');
            const closeNotificationButton = document.getElementById('closeNotification');
            const notificationMessage = document.getElementById('notificationMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const fileInput = document.getElementById('fileInput'); // Adicionado fileInput aqui

            let currentData = {}; // Armazena os dados do relatório atual
            let currentAction = null; // Armazena a ação atual para o modal de confirmação
            let currentIncidentKey = null; // Armazena a chave do incidente atual
            let isLargeScreen = window.innerWidth > 768;

            // Função para alternar a visibilidade do indicador de carregamento
            function toggleLoadingIndicator(show) {
                loadingIndicator.style.display = show ? 'flex' : 'none';
            }

            // Função para mostrar uma notificação
            function showNotification(message, icon = 'info') {
                notificationMessage.textContent = message;
                document.querySelector('.notification-icon').textContent = icon;
                notification.classList.add('show');
                setTimeout(() => {
                    hideNotification();
                }, 5000);
            }

            // Função para esconder a notificação
            function hideNotification() {
                notification.classList.remove('show');
            }

            // Adicionando um ouvinte de evento para fechar a notificação
            closeNotificationButton.addEventListener('click', hideNotification);

            // Carrega a tela inicial
            loadScreen('relatorios');

            // Eventos para os links da navegação
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const screen = link.getAttribute('data-screen');
                    loadScreen(screen);
                });
            });

            // Funções auxiliares
            function isValidReportId(reportId) {
                return /^AW-RIT-\d+$/.test(reportId);
            }

            function showConfirmationModal(message, yesAction) {
                document.getElementById('confirmationMessage').textContent = message;
                currentAction = yesAction;
                confirmationModal.style.display = 'block';
                setTimeout(() => {
                    confirmationModal.querySelector('.modal-content').classList.add('show');
                }, 10);
            }

            function resetAndCloseModal(modal) {
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.remove('show');
                modalContent.addEventListener('transitionend', function handler() {
                    modal.style.display = 'none';
                    modalContent.removeEventListener('transitionend', handler);
                    if (modal === newReportModal) {
                        document.getElementById('modalReportId').value = '';
                        document.getElementById('modalSummary').value = '';
                    }
                });
            }

            function handleModalInputError(inputId, isValid) {
                const inputElement = document.getElementById(inputId);
                const errorElement = document.getElementById(`${inputId}Error`);

                if (!isValid) {
                    inputElement.classList.add('input-error');
                    errorElement.style.display = 'block';
                } else {
                    inputElement.classList.remove('input-error');
                    errorElement.style.display = 'none';
                }
            }

            // Evento para fechar o modal de confirmação
            confirmationModal.querySelector('.close-button').addEventListener('click', () => {
                resetAndCloseModal(confirmationModal);
            });

            confirmYesButton.addEventListener('click', () => {
                if (currentAction) {
                    currentAction();
                }
                resetAndCloseModal(confirmationModal);
            });

            confirmNoButton.addEventListener('click', () => {
                resetAndCloseModal(confirmationModal);
            });

            function resetNewReportModal() {
                // Limpa os campos do formulário
                document.getElementById('modalReportId').value = '';
                document.getElementById('modalSummary').value = '';

                // Reseta as mensagens de erro
                document.getElementById('modalReportIdError').textContent = '';
                document.getElementById('modalReportIdError').style.display = 'none';
                document.getElementById('modalSummaryError').textContent = '';
                document.getElementById('modalSummaryError').style.display = 'none';

                // Remove as classes de erro dos campos de entrada
                document.getElementById('modalReportId').classList.remove('input-error');
                document.getElementById('modalSummary').classList.remove('input-error');
            }

            // Função para salvar em JSON
            function saveToJSONfile(data) {
                toggleLoadingIndicator(true);
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "data.json";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('Relatório salvo com sucesso!', 'save');
                setTimeout(() => {
                    toggleLoadingIndicator(false);
                }, 500);
            }

            // Função para carregar do JSON
            function loadFromJSONfile(fileInput) {
                toggleLoadingIndicator(true);
                return new Promise((resolve, reject) => {
                    const file = fileInput.files[0];
                    if (!file) {
                        toggleLoadingIndicator(false);
                        showNotification('Nenhum arquivo selecionado.', 'error');
                        reject("Selecione um arquivo JSON para carregar.");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            resolve(jsonData);
                            showNotification('Relatório carregado com sucesso!', 'check_circle');
                        } catch (error) {
                            toggleLoadingIndicator(false);
                            showNotification('Erro ao ler o JSON.', 'error');
                            reject("Erro ao ler o JSON: " + error.message);
                        }
                    };
                    reader.onerror = () => {
                        toggleLoadingIndicator(false);
                        showNotification('Erro ao ler o arquivo.', 'error');
                        reject("Erro ao ler o arquivo.");
                    };
                    reader.readAsText(file);
                }).finally(() => {
                    setTimeout(() => {
                        toggleLoadingIndicator(false);
                    }, 500);
                });
            }

            // Função para expandir texto
            function expandableText(content, button) {
                content.classList.toggle('expanded');
                button.innerHTML = content.classList.contains('expanded')
                    ? 'Ler menos <i class="material-icons icon">expand_less</i>'
                    : 'Ler mais <i class="material-icons icon">expand_more</i>';
            }

            // Função para criar conteúdo de tela
            function getScreenContent(screen) {
                const screens = {
                    relatorio: `
                        <div class="container-testIncidentForm">
                            <h1><i class="material-icons">assignment</i> Relatório de Incidentes de Teste</h1>
                            <form id="testIncidentForm">
                                <div class="form-header">
                                    <h2 id="reportId"></h2>
                                    <div class="expandable-text">
                                        <div id="summaryContainer" class="text-content">
                                            <h3 id="summary"></h3>
                                            <div class="fade-overlay"></div>
                                        </div>
                                        <button type="button" id="expandButton" class="expand-button">
                                            Ler mais <i class="material-icons icon">expand_more</i>
                                        </button>
                                    </div>
                                </div>
                                <div id="form-body"></div>
                                <div class="form-buttons">
                                    <button type="button" id="addIncidentButton"><i class="material-icons">add</i> Adicionar Incidente</button>
                                    <button type="submit"><i class="material-icons">save</i> Gerar Relatório</button>
                                </div>
                            </form>
                        </div>
                    `,
                    relatorios: `
                        <h1><i class="material-icons">library_books</i> Relatórios</h1>
                        <div id="options">
                            <div id="option1">
                                <label for="fileInput" class="file-input-label">
                                    <i class="material-icons">upload_file</i>
                                    <span>Carregar Relatório (JSON)</span>
                                </label>
                                <input type="file" id="fileInput" accept=".json" />
                            </div>
                            <div id="option2">
                                <button id="newReport" class="main-button">
                                    <i class="material-icons">add</i> Novo Relatório
                                </button>
                            </div>
                        </div>
                        <div id="testIncidents"></div>
                    `,
                    404: `<h1>404</h1><p>Tela não encontrada.</p>`
                };
                return screens[screen] || screens['404'];
            }

            // Função para carregar scripts de tela
            function loadScripts(screen, dataKey = null) {
                setTimeout(() => {
                    if (screen === 'relatorio') {
                        handleRelatorioScreen(dataKey);
                    } else if (screen === 'relatorios') {
                        handleRelatoriosScreen();
                    }
                }, 0);
            }

            // --- Funções para a tela de Relatório ---

            function handleRelatorioScreen(dataKey) {
                if (!dataKey || !currentData[dataKey]) {
                    console.error("Chave de relatório inválida ou dados não encontrados para:", dataKey);
                    showNotification('Erro ao carregar relatório.', 'error');
                    loadScreen('relatorios');
                    return;
                }

                let reportData = JSON.parse(JSON.stringify(currentData[dataKey]));
                const reportIdElement = document.getElementById('reportId');
                const summaryElement = document.getElementById('summary');
                const expandableSummary = document.getElementById('summaryContainer');
                const expandButton = document.getElementById('expandButton');
                const form = document.getElementById('testIncidentForm');
                const formBody = document.getElementById('form-body');
                const addIncidentButton = document.getElementById('addIncidentButton');

                reportIdElement.textContent = reportData.reportId;
                summaryElement.textContent = reportData.summary;

                expandButton.addEventListener('click', () => {
                    expandableText(expandableSummary, expandButton);
                });

                form.addEventListener('submit', (event) => {
                    event.preventDefault();
                    currentData[dataKey] = reportData;
                    saveToJSONfile(currentData);
                });

                addIncidentButton.addEventListener('click', () => {
                    addEmptyIncident(formBody, reportData);
                });

                function handleImagePasteOrDrop(event, textArea) {
                    const items = (event.clipboardData || event.dataTransfer).items;
                    for (const item of items) {
                        if (item.type.indexOf('image') === 0) {
                            const blob = item.getAsFile();
                            const reader = new FileReader();
                            const imageId = `image-${Date.now()}`;
                            reader.onload = (e) => {
                                const base64Image = e.target.result;
                                // Armazena a imagem Base64 em um elemento oculto ou em uma estrutura de dados
                                storeImageForIncident(textArea.id, base64Image, imageId);
                                // Exibe a imagem em um elemento img
                                displayImageInTextarea(textArea, base64Image, imageId);
                            };
                            reader.readAsDataURL(blob);
                        }
                    }
                }

                function storeImageForIncident(textAreaId, base64Image, imageId) {
                    // Encontre o incidente relevante com base no textAreaId
                    const incidentKey = textAreaId.split('-').slice(1).join('-');
                    const fieldKey = textAreaId.split('-')[0];
                    if (!reportData.incidents[incidentKey].images) {
                        reportData.incidents[incidentKey].images = {};
                    }

                    reportData.incidents[incidentKey].images[imageId] = { id: imageId, field: fieldKey, data: base64Image };
                }

                function displayImageInTextarea(textArea, base64Image, imageId) {
                    // Cria um contêiner para a imagem e o botão de exclusão
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';

                    // Cria um elemento de imagem
                    const img = document.createElement('img');
                    img.className = 'image-preview';
                    img.classList.add('image-preview-button');
                    img.src = base64Image;
                    img.addEventListener('click', () => {
                        openImageModal(base64Image);
                    });

                    // Adiciona um data attribute para armazenar o ID único da imagem
                    img.setAttribute('data-image-id', imageId);
                    console.log(`Imagem ID: ${imageId} \n Textarea ID: ${textArea.id}`);

                    // Cria um botão de exclusão
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-image-button';
                    deleteButton.innerHTML = '<i class="material-icons">close</i>';


                    // Adiciona um ouvinte de evento para o botão de exclusão
                    deleteButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        // Pede confirmação ao usuário antes de remover a imagem
                        if (confirm('Tem certeza que deseja remover esta imagem?')) {
                            removeImage(textArea, imageId);
                        }
                    });

                    // Adiciona a imagem e o botão de exclusão ao contêiner
                    imageContainer.appendChild(img);
                    imageContainer.appendChild(deleteButton);

                    if (!textArea.previousElementSibling?.classList.contains('images-container')) {
                        // Cria um contêiner para todas as imagens
                        const imagesContainer = document.createElement('div');
                        imagesContainer.className = 'images-container';

                        // Insere o contêiner antes do textarea
                        textArea.parentNode.insertBefore(imagesContainer, textArea);
                    }

                    // Insere o contêiner da imagem no contêiner existente
                    const imagesContainer = textArea.parentNode.querySelector('.images-container');
                    imagesContainer.appendChild(imageContainer);

                }

                function removeImage(textArea, imageId) {
                    // Encontra o contêiner da imagem com base no ID da imagem
                    const imageContainers = textArea.parentNode.querySelectorAll('div');
                    imageContainers.forEach(container => {
                        const img = container.querySelector(`img[data-image-id="${imageId}"]`);
                        if (img) {
                            container.remove(); // Remove o contêiner que envolve a imagem e o botão de exclusão

                            // Encontra o incidente relevante com base no textAreaId
                            const incidentKey = textArea.id.split('-').slice(0, 2).join('-');
                            const fieldKey = textArea.id.split('-')[0];

                            // Remove a imagem do objeto de dados do relatório, se existir
                            if (reportData.incidents[incidentKey]?.images?.[imageId]) {
                                delete reportData.incidents[incidentKey].images[imageId];
                            }
                        }
                    });
                }

                function openImageModal(base64Image) {
                    const modal = document.getElementById('imageModal');
                    const modalImage = document.getElementById('modalImage');
                    const modalContent = modal.querySelector('.modal-image-content');

                    modalImage.src = base64Image;
                    modal.style.display = 'block';

                    // Adiciona um atraso para garantir que o estilo 'display: block' seja aplicado antes de adicionar a classe 'show'
                    setTimeout(() => {
                        modalContent.classList.add('show');
                    }, 10);

                    // Fecha o modal quando o usuário clica no botão de fechar
                    const closeButton = modal.querySelector('.close-image-modal-button');
                    closeButton.onclick = () => {
                        closeImageModal();
                    };

                    // Fecha o modal quando o usuário clica fora da imagem
                    modal.onclick = (event) => {
                        if (event.target === modal) {
                            closeImageModal();
                        }
                    };
                }

                function closeImageModal() {
                    const modal = document.getElementById('imageModal');
                    const modalContent = modal.querySelector('.modal-image-content');
                    modalContent.classList.remove('show');

                    // Aguarda a transição de saída antes de definir o display como 'none'
                    modalContent.addEventListener('transitionend', function handler() {
                        modal.style.display = 'none';
                        modalContent.removeEventListener('transitionend', handler);
                    });
                }

                function addImageHandlingToTextarea(textArea) {
                    textArea.addEventListener('paste', (event) => {
                        event.preventDefault(); // Previne a colagem padrão
                        handleImagePasteOrDrop(event, textArea);
                    });

                    textArea.addEventListener('drop', (event) => {
                        event.preventDefault(); // Previne a ação padrão de arrastar e soltar
                        handleImagePasteOrDrop(event, textArea);
                    });
                }

                function createIncidentElement(incident, incidentKey) {
                    const details = document.createElement('details');
                    details.open = isLargeScreen;
                    const summary = document.createElement('summary');
                    const textSummary = document.createElement('span');
                    textSummary.className = 'text-summary';
                    textSummary.textContent = incident.testedItem || `Incidente ${incidentKey}`;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-incident-button';
                    deleteButton.innerHTML = '<i class="material-icons">delete</i>';
                    summary.appendChild(textSummary);
                    summary.appendChild(deleteButton);

                    deleteButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        event.preventDefault();
                        showConfirmationModal('Tem certeza que deseja excluir este incidente?', () => {
                            details.remove();
                            delete reportData.incidents[incidentKey];
                        });
                    });
                    details.appendChild(summary);

                    const content = document.createElement('div');
                    content.className = 'details-content';

                    const fields = [
                        { label: 'Identificador do incidente', placeholder: 'DM-IT-', key: 'incidentId', readonly: true },
                        { label: 'Item testado', placeholder: 'Nome do item testado', key: 'testedItem', required: true },
                        { label: 'Identificador do caso de teste', placeholder: 'AW-CT-ICDC-', key: 'testCaseId', readonly: true },
                        { label: 'Dados de entrada', placeholder: 'Todos os dados de entrada', key: 'inputData', type: 'textarea', required: true },
                        { label: 'Resultados esperados', placeholder: 'Todos os resultados esperados', key: 'expectedResults', type: 'textarea', required: true },
                        { label: 'Resultados obtidos', placeholder: 'Todos os resultados obtidos', key: 'obtainedResults', type: 'textarea', required: true },
                        { label: 'Observações', placeholder: 'Observações (se houver)', key: 'observations', type: 'textarea' },
                        { label: 'Anomalias', placeholder: 'Anomalias (se houver)', key: 'anomalies' },
                        { label: 'Data do incidente', key: 'incidentDate', type: 'datetime-local', required: true }
                    ];

                    fields.forEach(field => {
                        const formGroup = document.createElement('div');
                        formGroup.className = 'form-group';

                        const label = document.createElement('label');
                        label.htmlFor = `${field.key}-${incidentKey}`;
                        label.textContent = field.label;
                        if (field.required) {
                            label.classList.add('required-field');
                        }
                        formGroup.appendChild(label);

                        const input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
                        input.id = `${field.key}-${incidentKey}`;
                        input.name = input.id;
                        input.type = field.type || 'text';
                        input.value = incident[field.key] || '';
                        input.readOnly = field.readonly || false;
                        input.required = field.required || false;
                        input.placeholder = field.placeholder || '';

                        input.addEventListener('input', () => {
                            reportData.incidents[incidentKey][field.key] = input.value;
                            if (field.key === 'testedItem') {
                                textSummary.textContent = input.value;
                            }
                        });

                        formGroup.appendChild(input);
                        content.appendChild(formGroup);

                        if (field.type === 'textarea') {
                            addImageHandlingToTextarea(input);

                            // Carrega imagens existentes, se houver
                            if (incident.images) {
                                Object.values(incident.images).forEach(imageData => {
                                    if (imageData.field === field.key) {
                                        displayImageInTextarea(input, imageData.data, imageData.id);
                                    }
                                });
                            }
                        }
                    });

                    details.appendChild(content);
                    return details;
                }

                function addIncidents(formBody, reportData) {
                    formBody.innerHTML = '';
                    for (const incidentKey in reportData.incidents) {
                        const incident = reportData.incidents[incidentKey];
                        const details = createIncidentElement(incident, incidentKey);
                        formBody.appendChild(details);
                    }
                }

                function addEmptyIncident(formBody, reportData) {
                    const incidentKeys = Object.keys(reportData.incidents);
                    const lastIncidentKey = incidentKeys.length > 0 ? incidentKeys[incidentKeys.length - 1] : 'DM-IT-00';
                    const lastIncidentNumber = parseInt(lastIncidentKey.split('-').pop(), 10);
                    const newIncidentNumber = lastIncidentNumber + 1;
                    const newIncidentKey = `DM-IT-${String(newIncidentNumber).padStart(2, '0')}`;
                    const newIncidentId = newIncidentKey;
                    const newTestCaseId = `AW-CT-ICDC-${newIncidentNumber}`;

                    const emptyIncident = {
                        incidentId: newIncidentId,
                        testedItem: '',
                        testCaseId: newTestCaseId,
                        inputData: '',
                        expectedResults: '',
                        obtainedResults: '',
                        observations: '',
                        anomalies: '',
                        images: {},
                        incidentDate: new Date().toISOString().slice(0, 16)
                    };

                    reportData.incidents[newIncidentKey] = emptyIncident;
                    const details = createIncidentElement(emptyIncident, newIncidentKey);
                    formBody.appendChild(details);
                }

                addIncidents(formBody, reportData);
            }

            // --- Funções para a tela de Relatórios ---

            function handleRelatoriosScreen() {
                const fileInput = document.getElementById('fileInput');
                const testIncidents = document.getElementById('testIncidents');
                const newReportButton = document.getElementById('newReport');

                function showReport(reportKey) {
                    loadScreen('relatorio', reportKey);
                }

                function createReportCards(reports) {
                    const reportsHtml = Object.entries(reports).map(([key, report]) => `
                <div id="${key}" class="report-card">
                    <div class="report-card-background"></div>
                    <h2>${report.reportId}</h2>
                    <p>${report.summary}</p>
                </div>
            `).join('');
                    testIncidents.innerHTML = reportsHtml;

                    const cards = document.querySelectorAll('.report-card');
                    cards.forEach(card => {
                        card.addEventListener('click', () => {
                            showReport(card.id);
                        });
                    });
                }

                fileInput.addEventListener('change', () => {
                    toggleLoadingIndicator(true);
                    loadFromJSONfile(fileInput)
                        .then(result => {
                            currentData = result;
                            createReportCards(result);
                        })
                        .catch(error => {
                            showNotification('Erro ao carregar o relatório.', 'error');
                            console.error(error);
                        })
                        .finally(() => {
                            setTimeout(() => {
                                toggleLoadingIndicator(false);
                            }, 500);
                        });
                });

                newReportButton.addEventListener('click', () => {
                    openModal();
                });
            }

            // Função para carregar telas
            function loadScreen(screen, dataKey = null) {
                contentDiv.innerHTML = getScreenContent(screen);
                loadScripts(screen, dataKey);
            }

            // Função para abrir o modal
            function openModal() {
                resetNewReportModal();
                newReportModal.style.display = "block";
                setTimeout(() => {
                    newReportModal.querySelector('.modal-content').classList.add('show');
                }, 10);
            }

            // Função para fechar o modal
            function closeModal() {
                resetAndCloseModal(newReportModal);
            }

            // Evento para fechar o modal
            closeModalButton.addEventListener('click', closeModal);

            // Evento para criar um novo relatório
            createReportButton.addEventListener('click', () => {
                const reportId = document.getElementById('modalReportId').value;
                const summary = document.getElementById('modalSummary').value;

                const isValidId = isValidReportId(reportId);
                const isSummaryValid = summary.trim() !== '';

                handleModalInputError('modalReportId', isValidId);
                handleModalInputError('modalSummary', isSummaryValid);

                // Atualiza as mensagens de erro
                document.getElementById('modalReportIdError').textContent = !isValidId ? 'Formato inválido. Deve ser AW-RIT-X.' : '';
                document.getElementById('modalSummaryError').textContent = !isSummaryValid ? 'Resumo é obrigatório.' : '';

                if (isValidId && isSummaryValid) {
                    if (currentData[reportId]) {
                        showNotification('Relatório com esse ID já existe.', 'error');
                        return;
                    }

                    const newReport = { reportId, summary, incidents: {} };
                    currentData[reportId] = newReport;
                    closeModal();
                    showNotification('Novo relatório criado!', 'check_circle');
                    loadScreen('relatorio', reportId);
                }
            });

            // Fechar o modal se o usuário clicar fora dele
            window.addEventListener('click', (event) => {
                if (event.target === newReportModal) {
                    closeModal();
                } else if (event.target === confirmationModal) {
                    resetAndCloseModal(confirmationModal);
                }
            });

            // Prevenir o envio do formulário do modal
            newReportModal.addEventListener('submit', (event) => {
                event.preventDefault();
            });
        });
    </script>
    <!-- Adicionado a folha de estilo no final do documento -->
    <style>
        /* Variáveis para cores */
        :root {
            --primary-color: #0d47a1;
            /* Azul escuro para uma aparência profissional */
            --secondary-color: #1976d2;
            /* Azul médio para botões e destaques */
            --accent-color: #ff9800;
            /* Laranja para ícones e destaques */
            --error-color: #d32f2f;
            /* Vermelho escuro para mensagens de erro */
            --background-color: #f5f5f5;
            /* Cinza claro para o fundo */
            --text-color: #212121;
            /* Cinza escuro para texto principal */
            --border-color: #bdbdbd;
            /* Cinza médio para bordas */
            --white: #fff;
            /* Branco */
            --gray-light: #e0e0e0;
            /* Cinza claro para elementos secundários */
            --blue-light: #e3f2fd;
            /* Azul muito claro para fundos de detalhes e hover */
            --blue-hover: #bbdefb;
            /* Azul claro para hover */
            --button-hover: #1565c0;
            /* Azul um pouco mais escuro para hover de botões */
            --modal-overlay-color: rgba(0, 0, 0, 0.6);
            /* Preto transparente para o overlay do modal */
            --required-field-color: #c62828;
            /* Vermelho escuro para campos obrigatórios */
            --readonly-bg-color: #f5f5f5;
            /* Cinza claro para fundo de campos somente leitura */
            --readonly-text-color: #757575;
            /* Cinza médio para texto de campos somente leitura */
            --card-box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* Sombra para os cards */
        }

        /* Fonte */
        body {
            font-family: 'Roboto', sans-serif;
            /* Fonte moderna e legível */
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            overflow-x: hidden;
            /* Evita a rolagem horizontal */
        }

        /* Navegação */
        .menu {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center;
            background-color: var(--primary-color);
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--card-box-shadow);
        }

        .menu li {
            margin: 0 10px;
            position: relative;
            /* Para o efeito de hover */
        }

        .menu a {
            text-decoration: none;
            color: var(--white);
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: 500;
            display: flex;
            /* Alinha ícone e texto */
            align-items: center;
            /* Alinha verticalmente */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            /* Sombra sutil */
        }

        .menu a span {
            margin-left: 8px;
            /* Espaço entre o ícone e o texto */
        }

        .menu a:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* Ícones */
        .material-icons {
            vertical-align: middle;
            /* Alinha os ícones com o texto */
        }

        /* Container do Formulário */
        .container-testIncidentForm {
            max-width: 900px;
            margin: 30px auto;
            background: var(--white);
            padding: 40px;
            border-radius: 15px;
            box-shadow: var(--card-box-shadow);
        }

        /* Títulos */
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 40px;
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 15px;
            font-size: 2.5rem;
            position: relative;
        }

        h2,
        h3 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        h3 {
            margin-top: 0;
        }

        /* Grupos de Formulário */
        .form-group {
            margin-bottom: 25px;
        }

        /* Rótulos (Labels) */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* Campos de entrada */
        input[type="text"],
        input[type="date"],
        input[type="datetime-local"],
        input[type="time"],
        input[type="file"],
        textarea,
        select {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Foco nos campos */
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="datetime-local"]:focus,
        input[type="time"]:focus,
        input[type="file"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.5);
        }

        /* Textarea */
        textarea {
            height: 120px;
            resize: vertical;
        }

        /* Detalhes (Details) */
        details {
            margin: 15px 0;
            border-radius: 12px;
            background: var(--gray-light);
            overflow: hidden;
            transition: all 0.4s ease-in-out;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        details:not([open]) {
            transition: all 0.4s ease-out;
        }

        details[open] {
            background: var(--white);
            /* Altera o fundo quando aberto */
        }

        details>summary {
            font-weight: bold;
            cursor: pointer;
            padding: 15px;
            background: var(--blue-light);
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            /* Adiciona transições */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            /* Sombra sutil */
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        .delete-incident-button {
            color: var(--white);
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 5px 10px;
            border-radius: 6px;
            background-color: var(--error-color);
            border: none;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .delete-incident-button:hover {
            background-color: #b71c1c;
            /* Escurece no hover */
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        details[open]>summary {
            margin-bottom: 10px;
            border-radius: 12px 12px 0 0;
            background: var(--blue-hover);
            /* Altera o fundo do summary quando details está aberto */
        }

        details>summary:hover {
            background: var(--blue-hover);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            /* Sombra mais forte no hover */
        }

        details>.details-content {
            padding: 0 20px 15px;
        }

        /* Botões */
        button {
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            /* Adiciona transições */
            width: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            /* Sombra mais forte no hover */
        }

        .delete-image-button {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .image-container {
            position: relative;
            display: inline-block;
        }

        .image-preview {
            height: 100px;
            width: 100px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .image-preview-button {
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .image-preview-button:hover {
            transform: scale(1.05);
            box-shadow: 0px 0px 15px 4px rgb(0 152 169);
        }

        /* Modal para visualização de imagem */
        .modal-image-content {
            background-color: #fff;
            margin: 5% auto;
            /* Ajustado para melhor centralização */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: auto;
            /* Ajustado para a imagem se ajustar ao tamanho */
            max-width: 90%;
            /* Largura máxima */
            position: relative;
            opacity: 0;
            transform: translateY(-50px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: flex;
            /* Usando flexbox para centralizar a imagem */
            justify-content: center;
            /* Centralizar horizontalmente */
            align-items: center;
            /* Centralizar verticalmente */
        }

        .modal-image-content.show {
            opacity: 1;
            transform: translateY(0);
        }

        .modal-image-content img {
            max-width: 100%;
            /* A imagem se ajustará à largura do contêiner */
            max-height: 80vh;
            /* A imagem se ajustará à altura da viewport */
            object-fit: contain;
            /* A imagem será redimensionada para caber, mantendo a proporção */
            display: block;
            /* Elimina o espaço extra abaixo da imagem */
            margin: 0 auto;
            /* Centraliza a imagem no contêiner */
        }

        .close-image-modal-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
            background: none;
            border: none;
            padding: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .close-image-modal-button:hover {
            color: var(--accent-color);
        }

        /* Botões em grupos */
        .form-buttons {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 30px;
        }

        .form-buttons button {
            flex: 1;
        }

        /* Erros */
        .error {
            color: var(--error-color);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Cabeçalho do formulário */
        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Texto expansível */
        .expandable-text {
            border-radius: 12px;
            transition: all 0.4s ease-in-out;
            background-color: var(--gray-light);
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .text-content {
            overflow: hidden;
            position: relative;
            max-height: 15px;
            transition: max-height 0.4s ease-in-out;
            padding: 10px;
        }

        .text-content.expanded {
            max-height: 500px;
        }

        .fade-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: linear-gradient(transparent, var(--gray-light));
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .expanded .fade-overlay {
            opacity: 0;
        }

        .expand-button {
            display: block;
            width: calc(100% - 40px);
            text-align: center;
            padding: 10px;
            margin: 10px auto;
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            transition: color 0.3s ease;
            background-color: var(--blue-light);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .expand-button:hover {
            background-color: var(--blue-hover);
        }

        .icon {
            display: inline-block;
            transition: transform 0.4s ease;
            font-size: 1.2rem;
        }

        .expanded .icon {
            transform: rotate(180deg);
        }

        /* Animação de Fade In */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fadeIn 0.5s ease-out;
        }

        /* Estilização para os campos required no JavaScript */
        .required-field::after {
            content: " *";
            color: var(--required-field-color);
        }

        /* Estilização para os campos readonly */
        input[readonly],
        textarea[readonly] {
            background-color: var(--readonly-bg-color);
            color: var(--readonly-text-color);
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay-color);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 40%;
            max-width: 500px;
            position: relative;
            opacity: 0;
            transform: translateY(-50px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .modal-content.show {
            opacity: 1;
            transform: translateY(0);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.3s;
            background: none;
            border: none;
            padding: 0;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .close-button:hover {
            color: var(--accent-color);
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-input,
        .modal-textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 10px;
        }

        .modal-input:focus,
        .modal-textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 8px rgba(25, 118, 210, 0.5);
        }

        .modal-textarea {
            height: 100px;
            resize: vertical;
        }

        .modal-button {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .modal-button:hover {
            background-color: var(--button-hover);
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }

        .modal-buttons .confirm-button {
            background-color: #4CAF50;
            /* Cor para confirmação */
        }

        .modal-buttons .cancel-button {
            background-color: #f44336;
            /* Cor para cancelamento */
        }

        /* Estilos para o cartão de relatório */
        .report-card {
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin: 10px;
            overflow: hidden;
            position: relative;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.6s ease;
            width: 400px;
            height: 130px;
        }

        .report-card:hover {
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
            transform: translateY(-5px);
            /* Adicionado efeito de elevação */
        }

        .report-card h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 0px;
            z-index: 2;
        }

        .report-card p {
            color: var(--text-color);
            font-size: 1rem;
            padding: 10px;
            z-index: 2;
        }

        .report-card-background {
            background-color: var(--gray-light);
            height: 100%;
            left: 0;
            position: absolute;
            top: 0;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            width: 100%;
            z-index: 1;
        }

        .report-card:hover .report-card-background {
            transform: scale(2.5);
        }

        /* Melhoria da visualização em 3D */
        .report-card {
            backface-visibility: hidden;
        }

        /* Opções */
        #options {
            display: flex;
            justify-content: space-evenly;
            align-items: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        #options>div {
            flex: 1;
            min-width: 200px;
        }

        /* Lista de Incidentes */
        #testIncidents {
            display: flex;
            justify-content: space-evenly;
            flex-wrap: wrap;
            margin: 20px 0;
            perspective: 1000px;
            gap: 20px;
        }

        .text-summary {
            flex-grow: 1;
            /* Ocupa o espaço disponível */
        }

        /* Notificação */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 0.5s ease, transform 0.5s ease;
            z-index: 1001;
            /* Garante que a notificação fique acima do modal */
        }

        .notification-icon {
            margin-right: 10px;
            font-size: 24px;
        }

        .notification-message {
            margin-right: 10px;
            font-size: 1rem;
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--white);
            font-size: 1.2rem;
            line-height: 1;
        }

        .notification-close:hover {
            color: var(--gray-light);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .loading-indicator {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--white);
        }

        .spinner {
            border: 8px solid var(--gray-light);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-indicator p {
            font-size: 1.2rem;
            color: var(--white);
            font-weight: 600;
        }

        /* Estilos para telas menores */
        @media (max-width: 768px) {
            .form-buttons {
                flex-direction: column;
            }

            .form-buttons button {
                width: 100%;
                margin-bottom: 10px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .close-button {
                font-size: 20px;
                top: 5px;
                right: 10px;
            }

            .modal-input,
            .modal-textarea {
                font-size: 14px;
            }

            .modal-button {
                padding: 8px 16px;
                font-size: 14px;
            }

            .report-card {
                width: 95%;
                height: auto;
            }
        }
    </style>
</body>

</html>